# ============================================
# ULTRA OPTIMIZED .htaccess
# Core Web Vitals Focused
# Date: October 20, 2025 - FIXED styles.css references
# ============================================

# UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–∞
AddDefaultCharset UTF-8

# –û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–∫–∞–∑ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
Options -Indexes

# –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
DirectoryIndex index.html index.htm

# ====================================
# –£–ú–ù–´–ô HTTPS –†–ï–î–ò–†–ï–ö–¢ (–¥–ª—è –ø—Ä–æ–∫—Å–∏/CloudFlare)
# ====================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–∫—Å–∏/CloudFlare
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    # –ò–õ–ò –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
    RewriteCond %{HTTPS} off
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ —É—Å–ª–æ–≤–∏—è –≤—ã—à–µ –ù–ï –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ====================================
# –ó–ê–ì–û–õ–û–í–ö–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
# ====================================
<IfModule mod_headers.c>
    # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    Header set X-Content-Type-Options "nosniff"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    
    # HSTS - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π HTTPS
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Permissions-Policy - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ API –±—Ä–∞—É–∑–µ—Ä–∞
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ====================================
# BROTLI COMPRESSION
# ====================================
<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/plain
    AddOutputFilterByType BROTLI_COMPRESS text/css
    AddOutputFilterByType BROTLI_COMPRESS text/html
    AddOutputFilterByType BROTLI_COMPRESS text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/x-javascript
    AddOutputFilterByType BROTLI_COMPRESS application/json
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# ====================================
# GZIP FALLBACK COMPRESSION
# ====================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ====================================
# EXPIRES HEADERS - –ö–≠–®–ò–†–û–í–ê–ù–ò–ï
# ====================================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # HTML - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å
    ExpiresByType text/html "access plus 1 hour"
    
    # CSS –∏ JavaScript - 1 –º–µ—Å—è—Ü
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - 1 –≥–æ–¥
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # –®—Ä–∏—Ñ—Ç—ã - 1 –≥–æ–¥
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
</IfModule>

# ====================================
# CACHE-CONTROL HEADERS (–ò–°–ü–†–ê–í–õ–ï–ù–û)
# ====================================
<IfModule mod_headers.c>
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
    
    <FilesMatch "\.(jpg|jpeg|png|gif|svg|webp|ico)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    <FilesMatch "\.(woff|woff2|ttf|otf)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
</IfModule>

# ====================================
# MIME TYPES –î–õ–Ø –°–û–í–†–ï–ú–ï–ù–ù–´–• –§–û–†–ú–ê–¢–û–í
# ====================================
AddType image/webp .webp
AddType font/woff2 .woff2

# ====================================
# –ó–ê–©–ò–¢–ê –ö–û–ù–§–ò–î–ï–ù–¶–ò–ê–õ–¨–ù–´–• –§–ê–ô–õ–û–í
# ====================================
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "\.(bak|config|sql|log|sh|inc|swp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# ====================================
# OPTIMIZATION FOR CORE WEB VITALS
# üÜï –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ CSS —Ñ–∞–π–ª–æ–≤
# ====================================
<IfModule mod_headers.c>
    # Preconnect –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    <FilesMatch "\.html$">
        Header add Link "</styles-base.css>; rel=preload; as=style"
        Header append Link "</styles-content.css>; rel=preload; as=style"
        Header append Link "</styles-adaptive.css>; rel=preload; as=style"
        Header append Link "<https://fonts.googleapis.com>; rel=preconnect"
        Header append Link "<https://fonts.gstatic.com>; rel=preconnect; crossorigin"
    </FilesMatch>
</IfModule>

# ====================================
# ERROR PAGES
# ====================================
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# ====================================
# ETag OPTIMIZATION
# ====================================
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# ====================================
# ULTRA PERFORMANCE HEADERS
# üÜï –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ CSS —Ñ–∞–π–ª–æ–≤
# ====================================
<IfModule mod_headers.c>
    # Critical Resource Hints
    <FilesMatch "\.html$">
        Header add Link "</styles-base.css>; rel=preload; as=style"
        Header add Link "</styles-content.css>; rel=preload; as=style"
        Header add Link "</styles-adaptive.css>; rel=preload; as=style"
        Header add Link "</images/logo.jpg>; rel=preload; as=image; fetchpriority=high"
        Header add Link "<https://fonts.googleapis.com>; rel=preconnect"
        Header add Link "<https://fonts.gstatic.com>; rel=preconnect; crossorigin"
    </FilesMatch>
    
    # LCP Optimization
    <FilesMatch "logo\.jpg$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set Timing-Allow-Origin "*"
    </FilesMatch>
    
    # CLS Prevention
    Header always set Content-Security-Policy "script-src 'self' 'unsafe-inline' https://mc.yandex.ru https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:;"
</IfModule>

# ====================================
# BROTLI ULTRA COMPRESSION
# ====================================
<IfModule mod_brotli.c>
    AddOutputFilterByType BROTLI_COMPRESS text/plain
    AddOutputFilterByType BROTLI_COMPRESS text/css
    AddOutputFilterByType BROTLI_COMPRESS text/html
    AddOutputFilterByType BROTLI_COMPRESS text/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/javascript
    AddOutputFilterByType BROTLI_COMPRESS application/x-javascript
    AddOutputFilterByType BROTLI_COMPRESS application/json
    AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
    AddOutputFilterByType BROTLI_COMPRESS font/woff2
</IfModule>

# ====================================
# CACHE ULTRA OPTIMIZATION
# ====================================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # LCP Image - 1 year
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    
    # CSS & JS - 1 month
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # Fonts - 1 year
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    
    # HTML - 1 hour
    ExpiresByType text/html "access plus 1 hour"
</IfModule>